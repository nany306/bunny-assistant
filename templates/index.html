<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Mon Assistant IA</title>
    <style>
        /* (Styles CSS de la version pr√©c√©dente - inchang√©s) */
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 0; padding-bottom: 60px; background-color: #f4f4f9; color: #333; }
        .container { max-width: 600px; margin: 0 auto; padding: 20px; }
        .content-section { display: none; background: #fff; padding: 15px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05); margin-bottom: 20px; }
        .content-section.active { display: block; }
        h1 { color: #2c3e50; text-align: center; margin-bottom: 20px; font-size: 1.5em; }
        .form-group { margin-bottom: 10px; }
        .form-control { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box; }
        .input-row { display: flex; gap: 10px; margin-bottom: 10px; }
        .input-row .form-control { flex: 1; }
        .btn { background-color: #3498db; color: white; padding: 12px; border: none; border-radius: 6px; cursor: pointer; font-size: 16px; transition: background-color 0.3s; width: 100%; }
        .btn:hover { background-color: #2980b9; }
        .task-item { background: #ecf0f1; padding: 15px; margin-bottom: 10px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; border-left: 5px solid; }
        .task-item.high { border-left-color: #e74c3c; }
        .task-item.medium { border-left-color: #f39c12; }
        .task-item.low { border-left-color: #2ecc71; }
        .task-info { flex-grow: 1; }
        .task-info strong { display: block; font-size: 1.1em; }
        .btn-terminer { background-color: #e74c3c; padding: 8px 12px; margin-left: 10px; font-size: 14px; width: auto; }
        .btn-terminer:hover { background-color: #c0392b; }
        .settings-actions { display: flex; flex-direction: column; gap: 10px; margin-top: 15px; }
        .btn-green { background-color: #27ae60; }
        .btn-green:hover { background-color: #219d54; }
        .btn-orange { background-color: #f39c12; }
        .btn-orange:hover { background-color: #e67e22; }
        .nav-bar { position: fixed; bottom: 0; left: 0; right: 0; height: 60px; background-color: #fff; box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1); display: flex; justify-content: space-around; align-items: center; max-width: 600px; margin: 0 auto; }
        .nav-item { display: flex; flex-direction: column; align-items: center; color: #7f8c8d; cursor: pointer; font-size: 12px; padding: 5px 10px; }
        .nav-item.active { color: #3498db; }
        .nav-icon { font-size: 24px; margin-bottom: 2px; }
        
        /* --- Styles du Calendrier (Inchang√©s) --- */
        #calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; text-align: center; margin-top: 10px; }
        .day-header { font-weight: bold; color: #7f8c8d; padding: 5px 0; }
        .day-cell { padding: 10px 5px; border-radius: 8px; background-color: #f8f8f8; position: relative; cursor: pointer; transition: background-color 0.2s; font-size: 0.9em; }
        .day-cell:hover { background-color: #e0e0e0; }
        .current-day { background-color: #3498db !important; color: white; font-weight: bold; }
        .event-indicator { width: 6px; height: 6px; background-color: #e74c3c; border-radius: 50%; position: absolute; bottom: 3px; left: 50%; transform: translateX(-50%); }
        .event-details { margin-top: 10px; padding: 10px; background: #ecf0f1; border-radius: 8px; border-left: 5px solid #3498db; }
        
        /* Classe pour cacher les champs de date */
        .date-fields-hidden { display: none; }
    </style>
</head>
<body>
    <div class="container">
        <h1 id="main-title">T√¢ches Actives</h1>

        <div id="calendar-view" class="content-section">
            <h2>üìÖ Mon Calendrier</h2>
            <div id="calendar-display">
                </div>
            <div id="day-details" class="event-details" style="display: none;"></div>
        </div>

        <div id="tasks-view" class="content-section active">
            <h2>Nouvelle T√¢che / √âv√©nement</h2>
            
            <div class="form-group">
                <input type="text" id="nom" placeholder="Nom de la t√¢che / √©v√©nement" class="form-control" required>
            </div>

            <div class="input-row">
                <select id="type-event" class="form-control" onchange="toggleDateFields()">
                    <option value="Tache">Type: T√¢che √† faire</option>
                    <option value="RendezVous">Type: Rendez-vous / √âv√©nement</option>
                </select>
                <input type="number" id="duree" placeholder="Dur√©e (min)" value="60" min="5" class="form-control">
            </div>

            <div id="date-fields" class="input-row date-fields-hidden">
                <input type="date" id="date-debut" class="form-control" title="Date de d√©but">
                <input type="date" id="date-fin" class="form-control" title="Date de fin (optionnel)">
            </div>
            
            <div id="priority-fields" class="input-row">
                <select id="importance" class="form-control">
                    <option value="3" selected>Importance: Moyenne (3)</option>
                    <option value="5">Importance: Forte (5)</option>
                    <option value="1">Importance: Faible (1)</option>
                </select>
                <select id="urgence" class="form-control">
                    <option value="3" selected>Urgence: Moyenne (3)</option>
                    <option value="5">Urgence: Haute (5)</option>
                    <option value="1">Urgence: Basse (1)</option>
                </select>
            </div>
            
            <div class="form-group">
                <input type="text" id="projet" placeholder="Projet (ex: Dev, Finance)" value="Divers" class="form-control">
            </div>

            <button onclick="ajouterTache()" class="btn">
                Ajouter & Prioriser
            </button>
            
            <hr style="margin: 20px 0;">

            <h3>Liste Prioritaire (T√¢ches)</h3>
            <div id="priority-list">
                <div class="empty-state">Chargement...</div>
            </div>
        </div>

        <div id="settings-view" class="content-section">
            <h2>‚öôÔ∏è R√©glages et Sauvegarde</h2>
            <hr>
            <h3>Gestion de l'Inventaire (JSON)</h3>
            <p>Sauvegardez (T√©l√©charger) ou restaurez (Charger) votre liste.</p>
            <div class="settings-actions">
                <button class="btn btn-green" onclick="telechargerInventaire()">
                    üíæ T√©l√©charger l'Inventaire
                </button>
                <label for="uploadFile" class="btn btn-orange" style="cursor: pointer; text-align: center;">
                    ‚¨ÜÔ∏è Charger l'Inventaire
                </label>
                <input type="file" id="uploadFile" style="display: none;" onchange="chargerFichierInventaire(event)">
            </div>
        </div>
    </div>

    <div class="nav-bar">
        <div class="nav-item" onclick="changeView('calendar-view', this)" data-view="calendar-view">
            <span class="nav-icon">üìÖ</span> Calendrier
        </div>
        <div class="nav-item active" onclick="changeView('tasks-view', this)" data-view="tasks-view">
            <span class="nav-icon">‚úÖ</span> T√¢ches
        </div>
        <div class="nav-item" onclick="changeView('settings-view', this)" data-view="settings-view">
            <span class="nav-icon">‚öôÔ∏è</span> R√©glages
        </div>
    </div>


    <script>
        const API_BASE_URL = window.location.origin;
        const LOCAL_STORAGE_KEY = 'ia_assistant_inventaire';
        let inventaireGlobal = [];
        const JOURS = ['Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam', 'Dim'];
        let dateActuelle = new Date(); // Pour le calendrier

        // ---------------------------------------------------------------------
        // GESTION DES VUES (ONGLETS)
        // ---------------------------------------------------------------------

        function changeView(viewId, clickedElement) {
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.remove('active');
            });
            document.getElementById(viewId).classList.add('active');

            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            clickedElement.classList.add('active');

            // Mettre √† jour le titre et rafra√Æchir le calendrier si besoin
            if (viewId === 'calendar-view') {
                document.getElementById('main-title').textContent = 'Mon Calendrier';
                renderCalendar(); // Rafra√Æchir le calendrier √† chaque affichage
            } else if (viewId === 'settings-view') {
                document.getElementById('main-title').textContent = 'Configuration';
            } else {
                document.getElementById('main-title').textContent = 'T√¢ches Actives';
            }
        }
        
        // --- NOUVEAU: G√®re l'affichage des champs de date ---
        function toggleDateFields() {
            const type = document.getElementById('type-event').value;
            const dateFields = document.getElementById('date-fields');
            const priorityFields = document.getElementById('priority-fields');
            
            if (type === 'RendezVous') {
                dateFields.classList.remove('date-fields-hidden');
                priorityFields.classList.add('date-fields-hidden'); // On cache Urg/Imp pour les RDV
            } else { // Tache
                dateFields.classList.add('date-fields-hidden');
                priorityFields.classList.remove('date-fields-hidden'); // On montre Urg/Imp
            }
        }

        // ---------------------------------------------------------------------
        // GESTION DU LOCAL STORAGE
        // ---------------------------------------------------------------------

        function chargerInventaireLocal() {
            try {
                const data = localStorage.getItem(LOCAL_STORAGE_KEY);
                inventaireGlobal = data ? JSON.parse(data) : [];
            } catch (error) {
                console.error("Erreur LocalStorage:", error);
                inventaireGlobal = [];
            }
        }

        function sauvegarderInventaireLocal(nouveauInventaire) {
            inventaireGlobal = nouveauInventaire;
            localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(inventaireGlobal));
            fetchPriorites(); // Rafra√Æchir la liste des t√¢ches
            renderCalendar(); // Rafra√Æchir aussi le calendrier
        }

        // ---------------------------------------------------------------------
        // COMMUNICATION API 
        // ---------------------------------------------------------------------

        async function apiPost(endpoint, dataToSend) {
            try {
                const response = await fetch(`${API_BASE_URL}${endpoint}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(dataToSend)
                });
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || `Erreur HTTP ${response.status}`);
                }
                return await response.json();
            } catch (error) {
                console.error("Erreur API:", error);
                alert(`Erreur: ${error.message}`);
                return null;
            }
        }

        // ---------------------------------------------------------------------
        // LOGIQUE M√âTIER (T√ÇCHES)
        // ---------------------------------------------------------------------

        async function fetchPriorites() {
            const listElement = document.getElementById('priority-list');
            listElement.innerHTML = '<div class="empty-state">Calcul...</div>';

            const priorites = await apiPost('/api/v1/taches/priorite', { inventaire: inventaireGlobal });

            if (priorites && priorites.length > 0) {
                listElement.innerHTML = ''; 
                priorites.forEach(tache => {
                    // (L'API ne retourne que les t√¢ches actives, pas besoin de re-filtrer)
                    const item = document.createElement('div');
                    
                    // Note: Le score n'est plus envoy√© par l'API (masqu√©)
                    // On peut recr√©er une classe simple bas√©e sur Urg/Imp
                    let priorityClass = 'low';
                    if (tache.urgence >= 4 || tache.importance >= 4) {
                        priorityClass = 'medium';
                    }
                    if (tache.urgence === 5 && tache.importance === 5) {
                        priorityClass = 'high';
                    }
                    
                    item.className = `task-item ${priorityClass}`;
                    item.innerHTML = `
                        <div class="task-info">
                            <strong>${tache.nom}</strong>
                            <small>${tache.projet} | Imp: ${tache.importance} | Urg: ${tache.urgence} | Dur√©e: ${tache.duree_totale_minutes}min</small>
                        </div>
                        <button class="btn btn-terminer" onclick="terminerTache(${tache.db_id})">Terminer</button>
                    `;
                    listElement.appendChild(item);
                });
            } else if (priorites) {
                listElement.innerHTML = '<div class="empty-state">‚úÖ Aucune t√¢che active.</div>';
            }
        }

        async function ajouterTache() {
            const nom = document.getElementById('nom').value;
            const typeEvent = document.getElementById('type-event').value;
            const importance = document.getElementById('importance').value;
            const urgence = document.getElementById('urgence').value;
            const duree = document.getElementById('duree').value;
            const projet = document.getElementById('projet').value;
            
            // --- NOUVEAU: Gestion des dates ---
            const dateDebutInput = document.getElementById('date-debut').value;
            const dateFinInput = document.getElementById('date-fin').value;

            if (!nom || !duree) {
                alert("Veuillez remplir le nom et la dur√©e.");
                return;
            }
            
            const payload = {
                inventaire: inventaireGlobal, 
                nom: nom,
                type_event: typeEvent,
                importance: importance,
                urgence: urgence,
                duree: duree,
                projet: projet,
                // Envoie les dates si elles sont d√©finies, sinon null
                date_debut: dateDebutInput ? new Date(dateDebutInput).toISOString() : null,
                date_fin: dateFinInput ? new Date(dateFinInput).toISOString() : null
            };

            const nouvelInventaire = await apiPost('/api/v1/taches/ajouter', payload);
            
            if (nouvelInventaire) {
                sauvegarderInventaireLocal(nouvelInventaire);
                // R√©initialiser le formulaire
                document.getElementById('nom').value = '';
                document.getElementById('projet').value = 'Divers';
                document.getElementById('date-debut').value = '';
                document.getElementById('date-fin').value = '';
            }
        }

        async function terminerTache(db_id) {
            if (!confirm("Voulez-vous vraiment marquer cet √©v√©nement comme termin√© ?")) return;

            const payload = { inventaire: inventaireGlobal, db_id: db_id };
            const nouvelInventaire = await apiPost('/api/v1/taches/terminer', payload);

            if (nouvelInventaire) {
                sauvegarderInventaireLocal(nouvelInventaire);
            }
        }

        // ---------------------------------------------------------------------
        // LOGIQUE M√âTIER (CALENDRIER) - MIS √Ä JOUR
        // ---------------------------------------------------------------------
        
        function changeMonth(delta) {
            dateActuelle.setMonth(dateActuelle.getMonth() + delta);
            renderCalendar();
        }

        function renderCalendar() {
            const calendarDisplay = document.getElementById('calendar-display');
            const today = new Date();
            today.setHours(0, 0, 0, 0); // Normaliser aujourd'hui
            calendarDisplay.innerHTML = ''; 
            
            const monthYear = dateActuelle.toLocaleString('fr-FR', { month: 'long', year: 'numeric' });
            calendarDisplay.innerHTML += `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <button class="btn" style="width: 40px; padding: 5px; font-size: 1.2em;" onclick="changeMonth(-1)">&#9664;</button>
                    <h3 style="margin: 0;">${monthYear.charAt(0).toUpperCase() + monthYear.slice(1)}</h3>
                    <button class="btn" style="width: 40px; padding: 5px; font-size: 1.2em;" onclick="changeMonth(1)">&#9654;</button>
                </div>
            `;

            let gridHTML = '<div id="calendar-grid">';
            JOURS.forEach(day => gridHTML += `<div class="day-header">${day}</div>`);

            const annee = dateActuelle.getFullYear();
            const mois = dateActuelle.getMonth();
            const premierJour = new Date(annee, mois, 1);
            const dernierJour = new Date(annee, mois + 1, 0);
            
            let decalage = (premierJour.getDay() === 0) ? 6 : premierJour.getDay() - 1; 

            for (let i = 0; i < decalage; i++) {
                gridHTML += '<div class="day-cell" style="background: none; cursor: default;"></div>';
            }

            for (let jour = 1; jour <= dernierJour.getDate(); jour++) {
                const dateCellule = new Date(annee, mois, jour);
                const estAujourdhui = dateCellule.getTime() === today.getTime();
                
                let classes = 'day-cell';
                if (estAujourdhui) classes += ' current-day';
                
                // --- NOUVELLE LOGIQUE D'INDICATEUR ---
                // V√©rifie si un √©v√©nement (RDV) est actif ce jour-l√†
                const evenementsDuJour = inventaireGlobal.filter(e => {
                    if (e.type_event !== 'RendezVous' || !e.date_debut || e.est_complete) return false;
                    
                    const dateDebut = new Date(e.date_debut);
                    const dateFin = e.date_fin ? new Date(e.date_fin) : dateDebut;
                    
                    // Normaliser les dates pour comparer les jours (ignorer l'heure)
                    dateDebut.setHours(0, 0, 0, 0);
                    dateFin.setHours(23, 59, 59, 999); // Fin de journ√©e
                    
                    return dateCellule >= dateDebut && dateCellule <= dateFin;
                });

                const indicateurEvent = evenementsDuJour.length > 0 ? '<span class="event-indicator"></span>' : '';
                
                gridHTML += `<div class="${classes}" 
                                 onclick="showDayDetails(${jour}, ${mois}, ${annee})">
                                 ${jour}
                                 ${indicateurEvent}
                             </div>`;
            }

            gridHTML += '</div>';
            calendarDisplay.innerHTML += gridHTML;
            
            // Pr√©parer la div des d√©tails (mais la cacher)
            const detailsDiv = document.getElementById('day-details');
            if (detailsDiv) {
                detailsDiv.style.display = 'none';
                detailsDiv.innerHTML = '';
            } else {
                 calendarDisplay.innerHTML += '<div id="day-details" class="event-details" style="display: none;"></div>';
            }
        }

        function showDayDetails(jour, mois, annee) {
            const detailsDiv = document.getElementById('day-details');
            detailsDiv.style.display = 'block';
            
            const dateSelectionnee = new Date(annee, mois, jour);
            
            // --- LOGIQUE MISE √Ä JOUR ---
            const evenementsDuJour = inventaireGlobal.filter(e => {
                if (e.est_complete || !e.date_debut) return false;
                
                const dateDebut = new Date(e.date_debut);
                const dateFin = e.date_fin ? new Date(e.date_fin) : dateDebut;
                
                dateDebut.setHours(0, 0, 0, 0);
                dateFin.setHours(23, 59, 59, 999);
                
                return dateSelectionnee >= dateDebut && dateSelectionnee <= dateFin;
            });

            let htmlDetails = `<h4>D√©tails du ${jour}/${mois + 1}/${annee} :</h4>`;

            if (evenementsDuJour.length > 0) {
                evenementsDuJour.forEach(e => {
                    const couleur = e.type_event === 'RendezVous' ? '#3498db' : '#f39c12';
                    htmlDetails += `
                        <p style="margin: 5px 0; padding-left: 10px; border-left: 3px solid ${couleur};">
                            <strong>${e.type_event}</strong> : ${e.nom}
                        </p>
                    `;
                });
            } else {
                htmlDetails += '<p>Aucun √©v√©nement ou t√¢che planifi√©e pour ce jour.</p>';
            }
            detailsDiv.innerHTML = htmlDetails;
        }

        // ---------------------------------------------------------------------
        // FONCTIONS DE SAUVEGARDE (Inchang√©es)
        // ---------------------------------------------------------------------
        
        function telechargerInventaire() {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(inventaireGlobal, null, 2));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", `assistant_inventaire_${new Date().toISOString().slice(0, 10)}.json`);
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
            alert("Inventaire JSON t√©l√©charg√© !");
        }

        function chargerFichierInventaire(event) {
            const file = event.target.files[0];
            if (!file) return;
            if (file.type !== "application/json") {
                alert("Veuillez s√©lectionner un fichier JSON valide.");
                return;
            }
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    if (!Array.isArray(data)) throw new Error("Format JSON non valide.");
                    sauvegarderInventaireLocal(data);
                    alert("Inventaire charg√© avec succ√®s !");
                } catch (error) {
                    alert(`Erreur: Impossible de lire le fichier. (${error.message})`);
                }
            };
            reader.readAsText(file);
            document.getElementById('uploadFile').value = ''; 
        }

        // ---------------------------------------------------------------------
        // D√âMARRAGE DE L'APPLICATION
        // ---------------------------------------------------------------------

        window.onload = () => {
            chargerInventaireLocal();
            // Initialiser l'√©tat des champs de date
            toggleDateFields(); 
            // D√©marrer sur l'onglet 'T√¢ches'
            const tasksNav = document.querySelector('.nav-item[data-view="tasks-view"]');
            changeView('tasks-view', tasksNav);
            // Charger les priorit√©s initiales
            fetchPriorites();
        };

    </script>
</body>
</html>
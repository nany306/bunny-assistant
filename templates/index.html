<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IA Assistant Personnel</title>
    <style>
        /* Styles Globaux */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
            margin: 0;
            padding: 0;
            background-color: #f4f7f6;
            color: #333;
        }

        .container {
            max-width: 900px;
            margin: 20px auto;
            background-color: #ffffff;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            overflow: hidden;
        }

        header {
            background-color: #2c3e50;
            color: white;
            padding: 20px;
            text-align: center;
        }

        /* Navigation */
        nav {
            display: flex;
            justify-content: center;
            background-color: #34495e;
            padding: 0;
        }

        .nav-item {
            padding: 15px 25px;
            cursor: pointer;
            transition: background-color 0.3s;
            font-weight: 500;
            color: #ecf0f1;
            text-decoration: none;
            border-bottom: 3px solid transparent;
        }

        .nav-item:hover {
            background-color: #4a637c;
        }

        .nav-item.active {
            background-color: #2c3e50;
            border-bottom-color: #3498db;
        }

        /* Contenu Principal */
        main {
            padding: 20px;
        }

        .content-section {
            display: none;
            padding-top: 20px;
        }

        .content-section.active {
            display: block;
        }
        
        /* Formulaires */
        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #555;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            box-sizing: border-box;
            transition: border-color 0.3s;
        }

        .form-group input:focus, .form-group select:focus {
            border-color: #3498db;
            outline: none;
        }

        /* Boutons */
        .btn {
            background-color: #3498db;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.3s;
            font-weight: 600;
        }

        .btn:hover {
            background-color: #2980b9;
        }

        .btn-terminer {
            background-color: #2ecc71;
        }

        .btn-terminer:hover {
            background-color: #27ae60;
        }

        /* Liste de Priorités */
        #priority-list {
            margin-top: 20px;
        }

        .task-item {
            background-color: #ecf0f1;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-left: 5px solid;
            cursor: pointer;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }

        .task-item.high { border-left-color: #e74c3c; } /* Rouge */
        .task-item.medium { border-left-color: #f39c12; } /* Orange */
        .task-item.low { border-left-color: #3498db; } /* Bleu */
        
        .task-info {
            flex-grow: 1;
        }

        .task-info strong {
            display: block;
            margin-bottom: 3px;
            font-size: 1.1em;
        }

        .task-info small {
            color: #7f8c8d;
        }
        
        .empty-state {
            text-align: center;
            padding: 40px;
            color: #7f8c8d;
            border: 1px dashed #ccc;
            border-radius: 8px;
            margin-top: 20px;
        }

        /* Calendrier */
        #calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 2px;
            border: 1px solid #ccc;
            border-radius: 8px;
            background-color: #ddd;
            overflow: hidden;
            margin-top: 15px;
        }

        .day-header {
            background-color: #34495e;
            color: white;
            text-align: center;
            padding: 10px 5px;
            font-weight: 600;
            font-size: 0.9em;
        }

        .day-cell {
            background-color: white;
            padding: 10px 5px;
            text-align: center;
            min-height: 50px;
            font-weight: 500;
            position: relative;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .day-cell:hover {
            background-color: #f0f8ff;
        }

        .current-day {
            border: 2px solid #e74c3c;
            background-color: #fff0f0;
        }

        .event-indicator {
            position: absolute;
            bottom: 5px;
            left: 50%;
            transform: translateX(-50%);
            width: 8px;
            height: 8px;
            background-color: #3498db;
            border-radius: 50%;
        }

        .event-details {
            margin-top: 20px;
            padding: 15px;
            background-color: #ecf0f1;
            border-radius: 8px;
            border-left: 5px solid #3498db;
        }
        
        /* Modal d'édition */
        .modal {
            display: none; 
            position: fixed; 
            z-index: 1; 
            left: 0;
            top: 0;
            width: 100%; 
            height: 100%; 
            overflow: auto; 
            background-color: rgba(0,0,0,0.4); 
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 500px;
            border-radius: 10px;
            position: relative;
        }

        .close-btn {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }

        .close-btn:hover,
        .close-btn:focus {
            color: #000;
            text-decoration: none;
            cursor: pointer;
        }
        
        .date-fields-hidden {
            display: none;
        }

    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1 id="main-title">Tâches Actives</h1>
        </header>

        <nav>
            <div class="nav-item active" data-view="tasks-view" onclick="changeView('tasks-view', this)">Priorités</div>
            <div class="nav-item" data-view="calendar-view" onclick="changeView('calendar-view', this)">Calendrier</div>
            <div class="nav-item" data-view="settings-view" onclick="changeView('settings-view', this)">Configuration</div>
        </nav>

        <main>
            <section id="tasks-view" class="content-section active">
                <h2>Nouvel Événement/Tâche</h2>
                <form id="add-task-form" onsubmit="event.preventDefault(); ajouterTache()">
                    <div class="form-group">
                        <label for="type-event">Type :</label>
                        <select id="type-event" onchange="toggleDateFields()">
                            <option value="Tache">Tâche (À prioriser)</option>
                            <option value="RendezVous">Rendez-vous (Planifié)</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="nom">Nom de l'événement / Tâche :</label>
                        <input type="text" id="nom" required>
                    </div>

                    <div id="priority-fields" class="form-group">
                        <div style="display: flex; gap: 15px;">
                            <div class="form-group" style="flex: 1;">
                                <label for="importance">Importance (1-5) :</label>
                                <input type="number" id="importance" min="1" max="5" value="3">
                            </div>
                            <div class="form-group" style="flex: 1;">
                                <label for="urgence">Urgence (1-5) :</label>
                                <input type="number" id="urgence" min="1" max="5" value="3">
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="duree">Durée estimée (minutes) :</label>
                        <input type="number" id="duree" required value="60" min="10">
                    </div>
                    
                    <div class="form-group">
                        <label for="projet">Projet :</label>
                        <input type="text" id="projet" value="Divers">
                    </div>
                    
                    <div id="date-fields" class="date-fields-hidden">
                        <div style="display: flex; gap: 15px;">
                            <div class="form-group" style="flex: 1;">
                                <label for="date-debut">Date de début :</label>
                                <input type="date" id="date-debut">
                            </div>
                            <div class="form-group" style="flex: 1;">
                                <label for="time-debut">Heure de début :</label>
                                <input type="time" id="time-debut" value="09:00">
                            </div>
                        </div>
                    </div>
                    
                    <div id="recurrence-field" class="date-fields-hidden">
                        <label for="recurrence">Récurrence :</label>
                        <select id="recurrence">
                            <option value="none">Aucune</option>
                            <option value="daily">Quotidienne</option>
                            <option value="weekly">Hebdomadaire</option>
                            <option value="monthly">Mensuelle</option>
                        </select>
                    </div>

                    <button type="submit" class="btn" style="width: 100%;">Ajouter</button>
                </form>

                <h2 style="margin-top: 30px;">Tâches à Prioriser</h2>
                <div id="priority-list">
                    <div class="empty-state">Chargement des tâches...</div>
                </div>
            </section>

            <section id="calendar-view" class="content-section">
                <div id="calendar-display">
                    <div class="empty-state">Chargement du calendrier...</div>
                </div>
                <div id="day-details" class="event-details" style="display: none;"></div>
            </section>

            <section id="settings-view" class="content-section">
                <h2>Gestion des Données</h2>
                <p>Votre inventaire est stocké localement dans votre navigateur (LocalStorage).</p>
                <div style="display: flex; gap: 15px; margin-bottom: 20px;">
                    <button class="btn" onclick="telechargerInventaire()" style="flex: 1; background-color: #2c3e50;">Exporter (JSON)</button>
                    <input type="file" id="uploadFile" style="display: none;" onchange="chargerFichierInventaire(event)">
                    <button class="btn" onclick="document.getElementById('uploadFile').click()" style="flex: 1; background-color: #9b59b6;">Importer (JSON)</button>
                </div>
                
                <h2>Intégration Externe (Prochaine Étape)</h2>
                <p>C'est ici que nous allons configurer les connexions aux services externes (ex: Google Calendar, Générateur de Code, Suivi Budgétaire).</p>
            </section>
        </main>
        
        <div id="edit-modal" class="modal">
            <div class="modal-content">
                <span class="close-btn" onclick="closeEditModal()">&times;</span>
                <h3>Modifier l'Événement/Tâche</h3>
                <form onsubmit="event.preventDefault(); saveTaskChanges()">
                    <input type="hidden" id="edit-db-id">
                    <div class="form-group">
                        <label for="edit-nom">Nom :</label>
                        <input type="text" id="edit-nom" required>
                    </div>
                    <div class="form-group">
                        <div style="display: flex; gap: 15px;">
                            <div class="form-group" style="flex: 1;">
                                <label for="edit-importance">Importance (1-5) :</label>
                                <input type="number" id="edit-importance" min="1" max="5">
                            </div>
                            <div class="form-group" style="flex: 1;">
                                <label for="edit-urgence">Urgence (1-5) :</label>
                                <input type="number" id="edit-urgence" min="1" max="5">
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="edit-duree">Durée (minutes) :</label>
                        <input type="number" id="edit-duree" min="10">
                    </div>
                    <div class="form-group">
                        <label for="edit-projet">Projet :</label>
                        <input type="text" id="edit-projet">
                    </div>
                    
                    <button type="submit" class="btn" style="background-color: #3498db; margin-right: 10px;">Sauvegarder</button>
                    <button type="button" class="btn" onclick="deleteTask()" style="background-color: #e74c3c;">Supprimer</button>
                    <button type="button" class="btn" onclick="closeEditModal()" style="background-color: #95a5a6;">Annuler</button>
                </form>
            </div>
        </div>

    </div>

    <script>
        const API_BASE_URL = window.location.origin;
        const LOCAL_STORAGE_KEY = 'ia_assistant_inventaire';
        let inventaireGlobal = [];
        const JOURS = ['Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam', 'Dim'];
        let dateActuelle = new Date(); 

        // ---------------------------------------------------------------------
        // LOGIQUE D'EXPANSION DE LA RÉCURRENCE
        // ---------------------------------------------------------------------

        /**
         * Génère les instances futures des événements récurrents pour l'affichage.
         */
        function expandRecurrences(inventaire) {
            // Commence avec tous les événements actifs (non complétés)
            let expandedList = inventaire.filter(e => e.est_complete !== true); 
            const limitDate = new Date();
            // Limite la génération des événements à 6 mois dans le futur
            limitDate.setMonth(limitDate.getMonth() + 6); 

            inventaire.forEach(event => {
                // On n'étend que les RendezVous non complétés avec une règle de récurrence
                if (event.recurrence && event.recurrence !== 'none' && event.type_event === 'RendezVous' && event.date_debut && event.est_complete !== true) {
                    
                    const originalStartDate = new Date(event.date_debut);
                    const durationMs = event.duree_totale_minutes * 60000;
                    let currentDate = new Date(originalStartDate);
                    
                    // Avance la date pour commencer après l'événement original
                    if (event.recurrence === 'daily') currentDate.setDate(currentDate.getDate() + 1);
                    else if (event.recurrence === 'weekly') currentDate.setDate(currentDate.getDate() + 7);
                    else if (event.recurrence === 'monthly') currentDate.setMonth(currentDate.getMonth() + 1);

                    // Génère les instances futures
                    while (currentDate < limitDate) {
                        
                        // Création d'un nouvel objet pour l'instance récurrente
                        const newInstance = {
                            ...event,
                            // ID temporaire unique pour l'affichage (db_id + timestamp)
                            db_id: event.db_id + '_' + currentDate.getTime(), 
                            nom: event.nom, 
                            date_debut: new Date(currentDate).toISOString(),
                            date_fin: new Date(currentDate.getTime() + durationMs).toISOString(),
                            is_recurring_instance: true // Indicateur
                        };
                        expandedList.push(newInstance);

                        // Passe à l'instance suivante
                        if (event.recurrence === 'daily') currentDate.setDate(currentDate.getDate() + 1);
                        else if (event.recurrence === 'weekly') currentDate.setDate(currentDate.getDate() + 7);
                        else if (event.recurrence === 'monthly') currentDate.setMonth(currentDate.getMonth() + 1);
                        else break;
                    }
                }
            });

            return expandedList;
        }


        // ---------------------------------------------------------------------
        // GESTION DES VUES (ONGLETS)
        // ---------------------------------------------------------------------

        function changeView(viewId, clickedElement) {
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.remove('active');
            });
            document.getElementById(viewId).classList.add('active');

            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            clickedElement.classList.add('active');

            if (viewId === 'calendar-view') {
                document.getElementById('main-title').textContent = 'Mon Calendrier';
                renderCalendar(); 
            } else if (viewId === 'settings-view') {
                document.getElementById('main-title').textContent = 'Configuration';
            } else {
                document.getElementById('main-title').textContent = 'Tâches Actives';
                fetchPriorites();
            }
        }
        
        // --- Gère l'affichage des champs de date et récurrence ---
        function toggleDateFields() {
            const type = document.getElementById('type-event').value;
            const dateFields = document.getElementById('date-fields');
            const recurrenceField = document.getElementById('recurrence-field');
            const priorityFields = document.getElementById('priority-fields');
            
            if (type === 'RendezVous') {
                dateFields.classList.remove('date-fields-hidden');
                recurrenceField.classList.remove('date-fields-hidden');
                priorityFields.classList.add('date-fields-hidden'); 
            } else { // Tache
                // Les tâches peuvent aussi avoir une date/heure si on le souhaite, mais pas de récurrence simple
                dateFields.classList.remove('date-fields-hidden'); 
                recurrenceField.classList.add('date-fields-hidden');
                priorityFields.classList.remove('date-fields-hidden'); 
            }
        }

        /**
         * Ouvre l'onglet Tâches et pré-remplit le formulaire avec une date donnée.
         */
        function openAddTaskForm(jour, mois, annee) {
            // 1. Changer l'onglet pour "Tâches"
            const tasksNav = document.querySelector('.nav-item[data-view="tasks-view"]');
            changeView('tasks-view', tasksNav);

            // 2. Formater la date (YYYY-MM-DD)
            const dateObj = new Date(annee, mois, jour);
            const anneeStr = dateObj.getFullYear();
            const moisStr = String(dateObj.getMonth() + 1).padStart(2, '0');
            const jourStr = String(dateObj.getDate()).padStart(2, '0');
            const dateFormatee = `${anneeStr}-${moisStr}-${jourStr}`;

            // 3. Pré-remplir les champs
            document.getElementById('type-event').value = 'RendezVous'; // On part du principe que c'est un RDV
            document.getElementById('date-debut').value = dateFormatee;
            
            // 4. S'assurer que les champs de date sont visibles et réinitialiser la récurrence
            document.getElementById('recurrence').value = 'none';
            toggleDateFields();

            // 5. Mettre le focus sur le nom de l'événement
            document.getElementById('nom').focus();
        }

        // ---------------------------------------------------------------------
        // GESTION DU LOCAL STORAGE & API
        // ---------------------------------------------------------------------

        function chargerInventaireLocal() {
            try {
                const data = localStorage.getItem(LOCAL_STORAGE_KEY);
                inventaireGlobal = data ? JSON.parse(data) : [];
            } catch (error) {
                console.error("Erreur LocalStorage:", error);
                inventaireGlobal = [];
            }
        }

        function sauvegarderInventaireLocal(nouveauInventaire) {
            inventaireGlobal = nouveauInventaire;
            localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(inventaireGlobal));
            fetchPriorites(); 
            renderCalendar(); 
        }

        async function apiPost(endpoint, dataToSend) {
            try {
                const response = await fetch(`${API_BASE_URL}${endpoint}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(dataToSend)
                });
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || `Erreur HTTP ${response.status}`);
                }
                return await response.json();
            } catch (error) {
                console.error("Erreur API:", error);
                // Utiliser alert() pour que l'utilisateur voie immédiatement l'erreur
                alert(`Erreur: ${error.message}. Vérifiez les logs côté serveur si l'erreur persiste.`);
                return null;
            }
        }

        // ---------------------------------------------------------------------
        // LOGIQUE MÉTIER (TÂCHES)
        // ---------------------------------------------------------------------

        async function fetchPriorites() {
            const listElement = document.getElementById('priority-list');
            listElement.innerHTML = '<div class="empty-state">Calcul...</div>';

            const tachesAPrioriser = inventaireGlobal.filter(e => e.type_event !== 'RendezVous' && e.est_complete !== true);
            
            const priorites = await apiPost('/api/v1/taches/priorite', { inventaire: tachesAPrioriser });

            if (priorites && priorites.length > 0) {
                listElement.innerHTML = ''; 
                priorites.forEach(tache => {
                    const item = document.createElement('div');
                    
                    let priorityClass = 'low';
                    if (tache.urgence >= 4 || tache.importance >= 4) priorityClass = 'medium';
                    if (tache.urgence === 5 && tache.importance === 5) priorityClass = 'high';
                    
                    item.className = `task-item ${priorityClass}`;
                    item.setAttribute('onclick', `openEditModal(${tache.db_id})`);
                    
                    let dateInfo = '';
                    if (tache.date_debut) {
                        const dateObj = new Date(tache.date_debut);
                        dateInfo = ` | Début: ${dateObj.toLocaleDateString('fr-FR', { day: '2-digit', month: '2-digit' })} ${dateObj.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' })}`;
                    }

                    item.innerHTML = `
                        <div class="task-info">
                            <strong>${tache.nom}</strong>
                            <small>${tache.projet} | Imp: ${tache.importance} | Urg: ${tache.urgence} | Durée: ${tache.duree_totale_minutes}min${dateInfo}</small>
                        </div>
                        <button class="btn btn-terminer" onclick="event.stopPropagation(); terminerTache(${tache.db_id})">Terminer</button>
                    `;
                    listElement.appendChild(item);
                });
            } else if (priorites) {
                listElement.innerHTML = '<div class="empty-state">✅ Aucune tâche active à prioriser.</div>';
            }
        }


        async function ajouterTache() {
            const nom = document.getElementById('nom').value;
            const typeEvent = document.getElementById('type-event').value;
            const importance = document.getElementById('importance').value;
            const urgence = document.getElementById('urgence').value;
            const duree = document.getElementById('duree').value;
            const projet = document.getElementById('projet').value;
            const dateDebutInput = document.getElementById('date-debut').value;
            const timeDebutInput = document.getElementById('time-debut').value; 
            const recurrenceInput = document.getElementById('recurrence').value; 
            
            if (!nom || !duree) {
                alert("Veuillez remplir le nom et la durée.");
                return;
            }
            
            let dateDebutISO = null;
            let dateFinISO = null;
            
            if (dateDebutInput) { 
                const dateHeureDebut = new Date(`${dateDebutInput}T${timeDebutInput || '09:00'}:00`);
                dateDebutISO = dateHeureDebut.toISOString();
                
                const dateHeureFin = new Date(dateHeureDebut.getTime() + (parseInt(duree) * 60000)); 
                dateFinISO = dateHeureFin.toISOString();
            }
            
            const payload = {
                inventaire: inventaireGlobal, 
                nom: nom,
                type_event: typeEvent,
                importance: importance, 
                urgence: urgence,
                duree: duree,
                projet: projet,
                
                date_debut: dateDebutISO, 
                date_fin: dateFinISO,
                // La récurrence est stockée uniquement si c'est un RendezVous
                recurrence: typeEvent === 'RendezVous' ? recurrenceInput : 'none' 
            };

            const nouvelInventaire = await apiPost('/api/v1/taches/ajouter', payload);
            
            if (nouvelInventaire) {
                sauvegarderInventaireLocal(nouvelInventaire);
                // Réinitialiser le formulaire
                document.getElementById('nom').value = '';
                document.getElementById('projet').value = 'Divers';
                document.getElementById('date-debut').value = '';
                document.getElementById('type-event').value = 'Tache'; 
                document.getElementById('recurrence').value = 'none'; 
                toggleDateFields();
            }
        }
        
        async function terminerTache(db_id) {
            if (!confirm("Voulez-vous vraiment marquer cet événement comme terminé ?")) return;
            
            // Ne permet pas de terminer une instance récurrente temporaire
            if (String(db_id).includes('_')) {
                 alert("Vous ne pouvez marquer terminée que l'instance originale de l'événement.");
                 return;
            }

            const payload = { inventaire: inventaireGlobal, db_id: db_id };
            const nouvelInventaire = await apiPost('/api/v1/taches/terminer', payload);

            if (nouvelInventaire) {
                sauvegarderInventaireLocal(nouvelInventaire);
            }
        }


        // ---------------------------------------------------------------------
        // FONCTIONS DU MODAL D'ÉDITION
        // ---------------------------------------------------------------------
        
        function openEditModal(db_id) {
            // Utiliser l'ID de base si c'est une instance récurrente
            const base_db_id = parseInt(String(db_id).split('_')[0]); 
            const event = inventaireGlobal.find(e => e.db_id === base_db_id);
            if (!event) {
                alert("Erreur: Impossible de trouver l'événement.");
                return;
            }

            document.getElementById('edit-db-id').value = event.db_id;
            document.getElementById('edit-nom').value = event.nom;
            document.getElementById('edit-importance').value = event.importance;
            document.getElementById('edit-urgence').value = event.urgence;
            document.getElementById('edit-duree').value = event.duree_totale_minutes;
            document.getElementById('edit-projet').value = event.projet;

            document.getElementById('edit-modal').style.display = 'flex';
        }

        function closeEditModal() {
            document.getElementById('edit-modal').style.display = 'none';
        }

        function saveTaskChanges() {
            const db_id = parseInt(document.getElementById('edit-db-id').value);
            const eventIndex = inventaireGlobal.findIndex(e => e.db_id === db_id);
            if (eventIndex === -1) {
                alert("Erreur: Impossible de sauvegarder les modifications.");
                return;
            }

            // Mise à jour des propriétés
            inventaireGlobal[eventIndex].nom = document.getElementById('edit-nom').value;
            inventaireGlobal[eventIndex].importance = parseInt(document.getElementById('edit-importance').value);
            inventaireGlobal[eventIndex].urgence = parseInt(document.getElementById('edit-urgence').value);
            inventaireGlobal[eventIndex].duree_totale_minutes = parseInt(document.getElementById('edit-duree').value);
            inventaireGlobal[eventIndex].projet = document.getElementById('edit-projet').value;

            sauvegarderInventaireLocal(inventaireGlobal);
            closeEditModal();
        }
        
        function deleteTask() {
            if (!confirm("Êtes-vous sûr de vouloir supprimer cet événement définitivement ?")) return;
            
            const db_id = parseInt(document.getElementById('edit-db-id').value);
            const nouvelInventaire = inventaireGlobal.filter(e => e.db_id !== db_id);
            
            sauvegarderInventaireLocal(nouvelInventaire);
            closeEditModal();
        }


        // ---------------------------------------------------------------------
        // LOGIQUE MÉTIER (CALENDRIER)
        // ---------------------------------------------------------------------

        function changeMonth(delta) {
            dateActuelle.setMonth(dateActuelle.getMonth() + delta);
            renderCalendar();
        }

        function renderCalendar() {
            const calendarDisplay = document.getElementById('calendar-display');
            const today = new Date();
            today.setHours(0, 0, 0, 0); 
            calendarDisplay.innerHTML = ''; 
            
            const monthYear = dateActuelle.toLocaleString('fr-FR', { month: 'long', year: 'numeric' });
            calendarDisplay.innerHTML += `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <button class="btn" style="width: 40px; padding: 5px; font-size: 1.2em;" onclick="changeMonth(-1)">&#9664;</button>
                    <h3 style="margin: 0;">${monthYear.charAt(0).toUpperCase() + monthYear.slice(1)}</h3>
                    <button class="btn" style="width: 40px; padding: 5px; font-size: 1.2em;" onclick="changeMonth(1)">&#9654;</button>
                </div>
            `;

            let gridHTML = '<div id="calendar-grid">';
            JOURS.forEach(day => gridHTML += `<div class="day-header">${day}</div>`);

            const annee = dateActuelle.getFullYear();
            const mois = dateActuelle.getMonth();
            const dernierJour = new Date(annee, mois + 1, 0);
            
            // UTILISATION DE LA LOGIQUE DE RÉCURRENCE
            const allEvents = expandRecurrences(inventaireGlobal);
            
            let premierJour = new Date(annee, mois, 1);
            let decalage = (premierJour.getDay() === 0) ? 6 : premierJour.getDay() - 1; 

            for (let i = 0; i < decalage; i++) {
                gridHTML += '<div class="day-cell" style="background: none; cursor: default;"></div>';
            }

            for (let jour = 1; jour <= dernierJour.getDate(); jour++) {
                const dateCellule = new Date(annee, mois, jour);
                const estAujourdhui = dateCellule.getTime() === today.getTime();
                
                let classes = 'day-cell';
                if (estAujourdhui) classes += ' current-day';
                
                const evenementsDuJour = allEvents.filter(e => {
                    if (!e.date_debut || e.est_complete) return false;
                    
                    const dateDebut = new Date(e.date_debut);
                    const dateFin = e.date_fin ? new Date(e.date_fin) : dateDebut;
                    
                    dateDebut.setHours(0, 0, 0, 0);
                    dateFin.setHours(23, 59, 59, 999);
                    
                    return dateCellule >= dateDebut && dateCellule <= dateFin;
                });

                const indicateurEvent = evenementsDuJour.length > 0 ? '<span class="event-indicator"></span>' : '';
                
                gridHTML += `<div class="${classes}" 
                                 onclick="showDayDetails(${jour}, ${mois}, ${annee})">
                                 ${jour}
                                 ${indicateurEvent}
                             </div>`;
            }

            gridHTML += '</div>';
            calendarDisplay.innerHTML += gridHTML;
            
            // Ajoute l'élément de détails s'il n'existe pas
            if (!document.getElementById('day-details')) {
                 calendarDisplay.innerHTML += '<div id="day-details" class="event-details" style="display: none;"></div>';
            } else {
                document.getElementById('day-details').style.display = 'none';
                document.getElementById('day-details').innerHTML = '';
            }
        }
        
        // --- Affiche les détails du jour et permet l'ajout/édition ---
        function showDayDetails(jour, mois, annee) {
            const detailsDiv = document.getElementById('day-details');
            detailsDiv.style.display = 'block';
            
            const dateSelectionnee = new Date(annee, mois, jour);
            
            const allEvents = expandRecurrences(inventaireGlobal);
            
            const evenementsDuJour = allEvents.filter(e => {
                if (e.est_complete || !e.date_debut) return false;
                
                const dateDebut = new Date(e.date_debut);
                const dateFin = e.date_fin ? new Date(e.date_fin) : dateDebut;
                
                dateDebut.setHours(0, 0, 0, 0);
                dateFin.setHours(23, 59, 59, 999);
                
                return dateSelectionnee >= dateDebut && dateSelectionnee <= dateFin;
            });

            let htmlDetails = `<h4>Détails du ${jour}/${mois + 1}/${annee} :</h4>`;

            if (evenementsDuJour.length > 0) {
                evenementsDuJour.forEach(e => {
                    const type = e.type_event === 'RendezVous' ? 'RDV' : 'Tâche';
                    const couleur = e.type_event === 'RendezVous' ? '#3498db' : '#f39c12';
                    
                    const heureDebut = new Date(e.date_debut).toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
                    const recurrenceTag = e.is_recurring_instance ? ' (Répétition)' : '';

                    htmlDetails += `
                        <p style="margin: 5px 0; padding-left: 10px; border-left: 3px solid ${couleur}; cursor: pointer;"
                           onclick="openEditModal(${e.db_id})">
                            <strong style="color: ${couleur};">${type} (${heureDebut})</strong> : ${e.nom}${recurrenceTag}
                        </p>
                    `;
                });
            } else {
                htmlDetails += `<p>Aucun événement ou tâche planifiée pour ce jour. <span class="btn" onclick="openAddTaskForm(${jour}, ${mois}, ${annee})" style="padding: 5px; width: auto; display: inline-block;">Ajouter un événement</span></p>`;
            }
            detailsDiv.innerHTML = htmlDetails;
        }


        // ---------------------------------------------------------------------
        // FONCTIONS DE SAUVEGARDE
        // ---------------------------------------------------------------------
        
        function telechargerInventaire() {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(inventaireGlobal, null, 2));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", `assistant_inventaire_${new Date().toISOString().slice(0, 10)}.json`);
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
            alert("Inventaire JSON téléchargé !");
        }

        function chargerFichierInventaire(event) {
            const file = event.target.files[0];
            if (!file) return;
            if (file.type !== "application/json") {
                alert("Veuillez sélectionner un fichier JSON valide.");
                return;
            }
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    if (!Array.isArray(data)) throw new Error("Format JSON non valide.");
                    sauvegarderInventaireLocal(data);
                    alert("Inventaire chargé avec succès !");
                } catch (error) {
                    alert(`Erreur: Impossible de lire le fichier. (${error.message})`);
                }
            };
            reader.readAsText(file);
            document.getElementById('uploadFile').value = ''; 
        }

        // ---------------------------------------------------------------------
        // DÉMARRAGE DE L'APPLICATION
        // ---------------------------------------------------------------------

        window.onload = () => {
            chargerInventaireLocal();
            toggleDateFields(); 
            // S'assurer que la vue par défaut est bien activée après le chargement
            const tasksNav = document.querySelector('.nav-item[data-view="tasks-view"]');
            changeView('tasks-view', tasksNav);
            // La fonction changeView('tasks-view', ...) appelle déjà fetchPriorites()
        };

    </script>
</body>
</html>
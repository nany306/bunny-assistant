<script>
        const API_BASE_URL = window.location.origin;
        const LOCAL_STORAGE_KEY = 'ia_assistant_inventaire';
        let inventaireGlobal = [];
        const JOURS = ['Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam', 'Dim'];
        let dateActuelle = new Date(); 

        // ---------------------------------------------------------------------
        // NOUVEAU : LOGIQUE D'EXPANSION DE LA RÉCURRENCE
        // ---------------------------------------------------------------------

        /**
         * Génère les instances futures des événements récurrents pour l'affichage.
         * Note : Ces instances ne sont PAS sauvegardées dans le localStorage.
         * @param {Array} inventaire La liste des événements enregistrés.
         * @returns {Array} La liste complète des événements (originaux + récurrents).
         */
        function expandRecurrences(inventaire) {
            // Commence avec tous les événements actifs (non complétés)
            let expandedList = inventaire.filter(e => e.est_complete !== true); 
            const limitDate = new Date();
            // Limite la génération des événements à 6 mois dans le futur
            limitDate.setMonth(limitDate.getMonth() + 6); 

            inventaire.forEach(event => {
                // On n'étend que les RendezVous non complétés avec une règle de récurrence
                if (event.recurrence && event.recurrence !== 'none' && event.type_event === 'RendezVous' && event.date_debut && event.est_complete !== true) {
                    
                    const originalStartDate = new Date(event.date_debut);
                    const durationMs = event.duree_totale_minutes * 60000;
                    let currentDate = new Date(originalStartDate);
                    
                    // Avance la date pour commencer après l'événement original
                    if (event.recurrence === 'daily') currentDate.setDate(currentDate.getDate() + 1);
                    else if (event.recurrence === 'weekly') currentDate.setDate(currentDate.getDate() + 7);
                    else if (event.recurrence === 'monthly') currentDate.setMonth(currentDate.getMonth() + 1);

                    // Génère les instances futures
                    while (currentDate < limitDate) {
                        
                        const newInstance = {
                            ...event,
                            // ID temporaire unique pour l'affichage (db_id + timestamp)
                            db_id: event.db_id + '_' + currentDate.getTime(), 
                            nom: event.nom, 
                            date_debut: new Date(currentDate).toISOString(),
                            date_fin: new Date(currentDate.getTime() + durationMs).toISOString(),
                            is_recurring_instance: true // Indicateur
                        };
                        expandedList.push(newInstance);

                        // Passe à l'instance suivante
                        if (event.recurrence === 'daily') currentDate.setDate(currentDate.getDate() + 1);
                        else if (event.recurrence === 'weekly') currentDate.setDate(currentDate.getDate() + 7);
                        else if (event.recurrence === 'monthly') currentDate.setMonth(currentDate.getMonth() + 1);
                        else break;
                    }
                }
            });

            return expandedList;
        }

        // ---------------------------------------------------------------------
        // GESTION DES VUES (ONGLETS) - INCHANGÉE
        // ---------------------------------------------------------------------

        function changeView(viewId, clickedElement) {
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.remove('active');
            });
            document.getElementById(viewId).classList.add('active');

            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            clickedElement.classList.add('active');

            if (viewId === 'calendar-view') {
                document.getElementById('main-title').textContent = 'Mon Calendrier';
                renderCalendar(); 
            } else if (viewId === 'settings-view') {
                document.getElementById('main-title').textContent = 'Configuration';
            } else {
                document.getElementById('main-title').textContent = 'Tâches Actives';
            }
        }
        
        function toggleDateFields() {
            const type = document.getElementById('type-event').value;
            const dateFields = document.getElementById('date-fields');
            const recurrenceField = document.getElementById('recurrence-field');
            const priorityFields = document.getElementById('priority-fields');
            
            if (type === 'RendezVous') {
                dateFields.classList.remove('date-fields-hidden');
                recurrenceField.classList.remove('date-fields-hidden');
                priorityFields.classList.add('date-fields-hidden'); 
            } else { // Tache
                dateFields.classList.add('date-fields-hidden');
                recurrenceField.classList.add('date-fields-hidden');
                priorityFields.classList.remove('date-fields-hidden'); 
            }
        }

        function openAddTaskForm(jour, mois, annee) {
            const tasksNav = document.querySelector('.nav-item[data-view="tasks-view"]');
            changeView('tasks-view', tasksNav);

            const dateObj = new Date(annee, mois, jour);
            const anneeStr = dateObj.getFullYear();
            const moisStr = String(dateObj.getMonth() + 1).padStart(2, '0');
            const jourStr = String(dateObj.getDate()).padStart(2, '0');
            const dateFormatee = `${anneeStr}-${moisStr}-${jourStr}`;

            document.getElementById('type-event').value = 'RendezVous'; 
            document.getElementById('date-debut').value = dateFormatee;
            
            toggleDateFields();
            document.getElementById('nom').focus();
        }

        // ---------------------------------------------------------------------
        // GESTION DU LOCAL STORAGE & API - INCHANGÉE
        // ---------------------------------------------------------------------

        function chargerInventaireLocal() {
            try {
                const data = localStorage.getItem(LOCAL_STORAGE_KEY);
                inventaireGlobal = data ? JSON.parse(data) : [];
            } catch (error) {
                console.error("Erreur LocalStorage:", error);
                inventaireGlobal = [];
            }
        }

        function sauvegarderInventaireLocal(nouveauInventaire) {
            inventaireGlobal = nouveauInventaire;
            localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(inventaireGlobal));
            fetchPriorites(); 
            renderCalendar(); 
        }

        async function apiPost(endpoint, dataToSend) {
            try {
                const response = await fetch(`${API_BASE_URL}${endpoint}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(dataToSend)
                });
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || `Erreur HTTP ${response.status}`);
                }
                return await response.json();
            } catch (error) {
                console.error("Erreur API:", error);
                alert(`Erreur: ${error.message}`);
                return null;
            }
        }

        // ---------------------------------------------------------------------
        // LOGIQUE MÉTIER (TÂCHES) - INCHANGÉE
        // ---------------------------------------------------------------------

        async function fetchPriorites() {
            const listElement = document.getElementById('priority-list');
            listElement.innerHTML = '<div class="empty-state">Calcul...</div>';

            // IMPORTANT : On filtre les événements datés et récurrents de la liste de tâches,
            // pour ne garder que la to-do list pure à prioriser.
            const tachesAPrioriser = inventaireGlobal.filter(e => e.type_event !== 'RendezVous' && e.est_complete !== true);
            
            const priorites = await apiPost('/api/v1/taches/priorite', { inventaire: tachesAPrioriser });

            if (priorites && priorites.length > 0) {
                listElement.innerHTML = ''; 
                priorites.forEach(tache => {
                    const item = document.createElement('div');
                    
                    let priorityClass = 'low';
                    if (tache.urgence >= 4 || tache.importance >= 4) priorityClass = 'medium';
                    if (tache.urgence === 5 && tache.importance === 5) priorityClass = 'high';
                    
                    item.className = `task-item ${priorityClass}`;
                    item.setAttribute('onclick', `openEditModal(${tache.db_id})`);
                    
                    let dateInfo = '';
                    if (tache.date_debut) {
                        const dateObj = new Date(tache.date_debut);
                        dateInfo = ` | Début: ${dateObj.toLocaleDateString('fr-FR', { day: '2-digit', month: '2-digit' })} ${dateObj.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' })}`;
                    }

                    item.innerHTML = `
                        <div class="task-info">
                            <strong>${tache.nom}</strong>
                            <small>${tache.projet} | Imp: ${tache.importance} | Urg: ${tache.urgence} | Durée: ${tache.duree_totale_minutes}min${dateInfo}</small>
                        </div>
                        <button class="btn btn-terminer" onclick="event.stopPropagation(); terminerTache(${tache.db_id})">Terminer</button>
                    `;
                    listElement.appendChild(item);
                });
            } else if (priorites) {
                listElement.innerHTML = '<div class="empty-state">✅ Aucune tâche active à prioriser.</div>';
            }
        }


        async function ajouterTache() {
            const nom = document.getElementById('nom').value;
            const typeEvent = document.getElementById('type-event').value;
            const importance = document.getElementById('importance').value;
            const urgence = document.getElementById('urgence').value;
            const duree = document.getElementById('duree').value;
            const projet = document.getElementById('projet').value;
            const dateDebutInput = document.getElementById('date-debut').value;
            const timeDebutInput = document.getElementById('time-debut').value; 
            const recurrenceInput = document.getElementById('recurrence').value; 
            
            if (!nom || !duree) {
                alert("Veuillez remplir le nom et la durée.");
                return;
            }
            
            let dateDebutISO = null;
            let dateFinISO = null;
            
            if (dateDebutInput) { 
                const dateHeureDebut = new Date(`${dateDebutInput}T${timeDebutInput || '09:00'}:00`);
                dateDebutISO = dateHeureDebut.toISOString();
                
                const dateHeureFin = new Date(dateHeureDebut.getTime() + (parseInt(duree) * 60000)); 
                dateFinISO = dateHeureFin.toISOString();
            }
            
            const payload = {
                inventaire: inventaireGlobal, 
                nom: nom,
                type_event: typeEvent,
                importance: importance, 
                urgence: urgence,
                duree: duree,
                projet: projet,
                
                date_debut: dateDebutISO, 
                date_fin: dateFinISO,
                recurrence: typeEvent === 'RendezVous' ? recurrenceInput : 'none' // Récurrence uniquement pour les RDV
            };

            const nouvelInventaire = await apiPost('/api/v1/taches/ajouter', payload);
            
            if (nouvelInventaire) {
                sauvegarderInventaireLocal(nouvelInventaire);
                // Réinitialiser le formulaire
                document.getElementById('nom').value = '';
                document.getElementById('projet').value = 'Divers';
                document.getElementById('date-debut').value = '';
                document.getElementById('type-event').value = 'Tache'; 
                document.getElementById('recurrence').value = 'none'; // Réinitialiser récurrence
                toggleDateFields();
            }
        }
        
        async function terminerTache(db_id) {
            if (!confirm("Voulez-vous vraiment marquer cet événement comme terminé ?")) return;
            // Si c'est une instance récurrente, on ne peut pas la marquer terminée car elle est temporaire.
            // On ne peut marquer terminée que les événements originaux stockés (dont l'ID est un nombre).
            if (String(db_id).includes('_')) {
                 alert("Vous ne pouvez pas marquer une instance récurrente (temporaire) comme terminée. Marquez l'événement original.");
                 return;
            }


            const payload = { inventaire: inventaireGlobal, db_id: db_id };
            const nouvelInventaire = await apiPost('/api/v1/taches/terminer', payload);

            if (nouvelInventaire) {
                sauvegarderInventaireLocal(nouvelInventaire);
            }
        }


        // ---------------------------------------------------------------------
        // FONCTIONS DU MODAL D'ÉDITION - INCHANGÉES (elles gèrent l'original stocké)
        // ---------------------------------------------------------------------
        
        function openEditModal(db_id) {
            // Utiliser l'ID de base si c'est une instance récurrente
            const base_db_id = parseInt(String(db_id).split('_')[0]); 
            const event = inventaireGlobal.find(e => e.db_id === base_db_id);
            if (!event) {
                alert("Erreur: Impossible de trouver l'événement.");
                return;
            }

            document.getElementById('edit-db-id').value = event.db_id;
            document.getElementById('edit-nom').value = event.nom;
            document.getElementById('edit-importance').value = event.importance;
            document.getElementById('edit-urgence').value = event.urgence;
            document.getElementById('edit-duree').value = event.duree_totale_minutes;
            document.getElementById('edit-projet').value = event.projet;

            document.getElementById('edit-modal').style.display = 'flex';
        }

        function closeEditModal() {
            document.getElementById('edit-modal').style.display = 'none';
        }

        function saveTaskChanges() {
            const db_id = parseInt(document.getElementById('edit-db-id').value);
            const eventIndex = inventaireGlobal.findIndex(e => e.db_id === db_id);
            // ... (logique de sauvegarde inchangée) ...
            inventaireGlobal[eventIndex].nom = document.getElementById('edit-nom').value;
            inventaireGlobal[eventIndex].importance = parseInt(document.getElementById('edit-importance').value);
            inventaireGlobal[eventIndex].urgence = parseInt(document.getElementById('edit-urgence').value);
            inventaireGlobal[eventIndex].duree_totale_minutes = parseInt(document.getElementById('edit-duree').value);
            inventaireGlobal[eventIndex].projet = document.getElementById('edit-projet').value;

            sauvegarderInventaireLocal(inventaireGlobal);
            closeEditModal();
        }
        
        function deleteTask() {
            if (!confirm("Êtes-vous sûr de vouloir supprimer cet événement définitivement ?")) return;
            
            const db_id = parseInt(document.getElementById('edit-db-id').value);
            const nouvelInventaire = inventaireGlobal.filter(e => e.db_id !== db_id);
            
            sauvegarderInventaireLocal(nouvelInventaire);
            closeEditModal();
        }


        // ---------------------------------------------------------------------
        // LOGIQUE MÉTIER (CALENDRIER) - MISES À JOUR
        // ---------------------------------------------------------------------

        function changeMonth(delta) {
            dateActuelle.setMonth(dateActuelle.getMonth() + delta);
            renderCalendar();
        }

        function renderCalendar() {
            const calendarDisplay = document.getElementById('calendar-display');
            const today = new Date();
            today.setHours(0, 0, 0, 0); 
            calendarDisplay.innerHTML = ''; 
            
            const monthYear = dateActuelle.toLocaleString('fr-FR', { month: 'long', year: 'numeric' });
            // ... (Affichage du titre et des boutons) ...
            calendarDisplay.innerHTML += `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <button class="btn" style="width: 40px; padding: 5px; font-size: 1.2em;" onclick="changeMonth(-1)">&#9664;</button>
                    <h3 style="margin: 0;">${monthYear.charAt(0).toUpperCase() + monthYear.slice(1)}</h3>
                    <button class="btn" style="width: 40px; padding: 5px; font-size: 1.2em;" onclick="changeMonth(1)">&#9654;</button>
                </div>
            `;

            let gridHTML = '<div id="calendar-grid">';
            JOURS.forEach(day => gridHTML += `<div class="day-header">${day}</div>`);

            const annee = dateActuelle.getFullYear();
            const mois = dateActuelle.getMonth();
            const dernierJour = new Date(annee, mois + 1, 0);
            
            // --- NOUVEAU : Utilisation de la liste des événements étendue ---
            const allEvents = expandRecurrences(inventaireGlobal);
            
            // ... (Calcul du décalage et affichage des jours vides) ...

            let premierJour = new Date(annee, mois, 1);
            let decalage = (premierJour.getDay() === 0) ? 6 : premierJour.getDay() - 1; 

            for (let i = 0; i < decalage; i++) {
                gridHTML += '<div class="day-cell" style="background: none; cursor: default;"></div>';
            }

            for (let jour = 1; jour <= dernierJour.getDate(); jour++) {
                const dateCellule = new Date(annee, mois, jour);
                const estAujourdhui = dateCellule.getTime() === today.getTime();
                
                let classes = 'day-cell';
                if (estAujourdhui) classes += ' current-day';
                
                // Recherche des événements dans la liste étendue
                const evenementsDuJour = allEvents.filter(e => {
                    if (!e.date_debut || e.est_complete) return false;
                    
                    const dateDebut = new Date(e.date_debut);
                    const dateFin = e.date_fin ? new Date(e.date_fin) : dateDebut;
                    
                    dateDebut.setHours(0, 0, 0, 0);
                    dateFin.setHours(23, 59, 59, 999);
                    
                    return dateCellule >= dateDebut && dateCellule <= dateFin;
                });

                const indicateurEvent = evenementsDuJour.length > 0 ? '<span class="event-indicator"></span>' : '';
                
                // Le clic ouvre le formulaire d'ajout
                gridHTML += `<div class="${classes}" 
                                 onclick="openAddTaskForm(${jour}, ${mois}, ${annee})">
                                 ${jour}
                                 ${indicateurEvent}
                             </div>`;
            }

            gridHTML += '</div>';
            calendarDisplay.innerHTML += gridHTML;
            
            // ... (Affichage des détails) ...
            const detailsDiv = document.getElementById('day-details');
            if (detailsDiv) {
                detailsDiv.style.display = 'none';
                detailsDiv.innerHTML = '';
            } else {
                 calendarDisplay.innerHTML += '<div id="day-details" class="event-details" style="display: none;"></div>';
            }
        }
        
        // --- showDayDetails utilise aussi expandRecurrences ---
        function showDayDetails(jour, mois, annee) {
             const detailsDiv = document.getElementById('day-details');
            detailsDiv.style.display = 'block';
            
            const dateSelectionnee = new Date(annee, mois, jour);
            
            // --- NOUVEAU : Utilisation de la liste des événements étendue ---
            const allEvents = expandRecurrences(inventaireGlobal);
            
            const evenementsDuJour = allEvents.filter(e => {
                if (e.est_complete || !e.date_debut) return false;
                
                const dateDebut = new Date(e.date_debut);
                const dateFin = e.date_fin ? new Date(e.date_fin) : dateDebut;
                
                dateDebut.setHours(0, 0, 0, 0);
                dateFin.setHours(23, 59, 59, 999);
                
                return dateSelectionnee >= dateDebut && dateSelectionnee <= dateFin;
            });

            let htmlDetails = `<h4>Détails du ${jour}/${mois + 1}/${annee} :</h4>`;

            if (evenementsDuJour.length > 0) {
                evenementsDuJour.forEach(e => {
                    const type = e.type_event === 'RendezVous' ? 'RDV' : 'Tâche';
                    const couleur = e.type_event === 'RendezVous' ? '#3498db' : '#f39c12';
                    
                    const heureDebut = new Date(e.date_debut).toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });

                    // Le clic ouvre le modal d'édition de l'événement original
                    htmlDetails += `
                        <p style="margin: 5px 0; padding-left: 10px; border-left: 3px solid ${couleur}; cursor: pointer;"
                           onclick="openEditModal(${e.db_id})">
                            <strong style="color: ${couleur};">${type} (${heureDebut})</strong> : ${e.nom}
                            ${e.is_recurring_instance ? ' (Répétition)' : ''}
                        </p>
                    `;
                });
            } else {
                htmlDetails += `<p>Aucun événement ou tâche planifiée pour ce jour. <span class="btn" onclick="openAddTaskForm(${jour}, ${mois}, ${annee})" style="padding: 5px; width: auto; display: inline-block;">Ajouter un événement</span></p>`;
            }
            detailsDiv.innerHTML = htmlDetails;
        }


        // ---------------------------------------------------------------------
        // FONCTIONS DE SAUVEGARDE (Inchangées)
        // ---------------------------------------------------------------------
        
        function telechargerInventaire() {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(inventaireGlobal, null, 2));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", `assistant_inventaire_${new Date().toISOString().slice(0, 10)}.json`);
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
            alert("Inventaire JSON téléchargé !");
        }

        function chargerFichierInventaire(event) {
            const file = event.target.files[0];
            if (!file) return;
            if (file.type !== "application/json") {
                alert("Veuillez sélectionner un fichier JSON valide.");
                return;
            }
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    if (!Array.isArray(data)) throw new Error("Format JSON non valide.");
                    sauvegarderInventaireLocal(data);
                    alert("Inventaire chargé avec succès !");
                } catch (error) {
                    alert(`Erreur: Impossible de lire le fichier. (${error.message})`);
                }
            };
            reader.readAsText(file);
            document.getElementById('uploadFile').value = ''; 
        }

        // ---------------------------------------------------------------------
        // DÉMARRAGE DE L'APPLICATION (Inchangé)
        // ---------------------------------------------------------------------

        window.onload = () => {
            chargerInventaireLocal();
            toggleDateFields(); 
            const tasksNav = document.querySelector('.nav-item[data-view="tasks-view"]');
            changeView('tasks-view', tasksNav);
            fetchPriorites();
        };

    </script>
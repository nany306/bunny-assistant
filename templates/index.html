<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Mon Assistant IA</title>
    <style>
        /* (Tous les styles CSS précédents...) */
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 0; padding-bottom: 60px; background-color: #f4f4f9; color: #333; }
        .container { max-width: 600px; margin: 0 auto; padding: 20px; }
        .content-section { display: none; background: #fff; padding: 15px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05); margin-bottom: 20px; }
        .content-section.active { display: block; }
        h1 { color: #2c3e50; text-align: center; margin-bottom: 20px; font-size: 1.5em; }
        .form-group { margin-bottom: 10px; }
        .form-control { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box; }
        .input-row { display: flex; gap: 10px; margin-bottom: 10px; }
        .input-row .form-control { flex: 1; }
        .btn { background-color: #3498db; color: white; padding: 12px; border: none; border-radius: 6px; cursor: pointer; font-size: 16px; transition: background-color 0.3s; width: 100%; }
        .btn:hover { background-color: #2980b9; }
        
        /* --- Styles de la Liste de Tâches --- */
        .task-item { background: #ecf0f1; padding: 15px; margin-bottom: 10px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; border-left: 5px solid; cursor: pointer; /* <== Rendu cliquable */ }
        .task-item.high { border-left-color: #e74c3c; }
        .task-item.medium { border-left-color: #f39c12; }
        .task-item.low { border-left-color: #2ecc71; }
        .task-info { flex-grow: 1; }
        .task-info strong { display: block; font-size: 1.1em; }
        .btn-terminer { background-color: #2ecc71; padding: 8px 12px; margin-left: 10px; font-size: 14px; width: auto; z-index: 10; /* Pour être cliquable par-dessus l'item */ }
        .btn-terminer:hover { background-color: #27ae60; }
        
        /* (Styles du Calendrier...) */
        #calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; text-align: center; margin-top: 10px; }
        .day-header { font-weight: bold; color: #7f8c8d; padding: 5px 0; }
        .day-cell { padding: 10px 5px; border-radius: 8px; background-color: #f8f8f8; position: relative; cursor: pointer; font-size: 0.9em; }
        .current-day { background-color: #3498db !important; color: white; }
        .event-indicator { width: 6px; height: 6px; background-color: #e74c3c; border-radius: 50%; position: absolute; bottom: 3px; left: 50%; transform: translateX(-50%); }
        .event-details { margin-top: 10px; padding: 10px; background: #ecf0f1; border-radius: 8px; border-left: 5px solid #3498db; }
        .date-fields-hidden { display: none; }
        
        /* (Styles de la Nav Bar...) */
        .nav-bar { position: fixed; bottom: 0; left: 0; right: 0; height: 60px; background-color: #fff; box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1); display: flex; justify-content: space-around; align-items: center; max-width: 600px; margin: 0 auto; z-index: 100; }
        .nav-item { display: flex; flex-direction: column; align-items: center; color: #7f8c8d; cursor: pointer; font-size: 12px; padding: 5px 10px; }
        .nav-item.active { color: #3498db; }
        .nav-icon { font-size: 24px; margin-bottom: 2px; }

        /* --- NOUVEAU : Styles du Modal d'Édition --- */
        .modal-overlay {
            display: none; /* Caché par défaut */
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(0, 0, 0, 0.6);
            z-index: 999;
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background: #fff;
            padding: 20px;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }
        .modal-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        .btn-danger { background-color: #e74c3c; }
        .btn-danger:hover { background-color: #c0392b; }
        .btn-secondary { background-color: #95a5a6; }
        .btn-secondary:hover { background-color: #7f8c8d; }
    </style>
</head>
<body>
    <div class="container">
        <h1 id="main-title">Tâches Actives</h1>

        <div id="calendar-view" class="content-section">
            </div>

        <div id="tasks-view" class="content-section active">
            <hr style="margin: 20px 0;">
            <h3>Liste Prioritaire (Tâches)</h3>
            <div id="priority-list">
                </div>
        </div>

        <div id="settings-view" class="content-section">
            </div>
    </div>

    <div class="nav-bar">
        </div>

    <div id="edit-modal" class="modal-overlay" onclick="closeEditModal()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <h3>Modifier l'Événement</h3>
            
            <input type="hidden" id="edit-db-id">
            
            <div class="form-group">
                <label for="edit-nom">Nom</label>
                <input type="text" id="edit-nom" class="form-control" required>
            </div>
            
            <div class="input-row">
                 <select id="edit-importance" class="form-control">
                    <option value="5">Importance: 5</option>
                    <option value="4">Importance: 4</option>
                    <option value="3">Importance: 3</option>
                    <option value="2">Importance: 2</option>
                    <option value="1">Importance: 1</option>
                </select>
                <select id="edit-urgence" class="form-control">
                    <option value="5">Urgence: 5</option>
                    <option value="4">Urgence: 4</option>
                    <option value="3">Urgence: 3</option>
                    <option value="2">Urgence: 2</option>
                    <option value="1">Urgence: 1</option>
                </select>
            </div>
             <div class="form-group">
                <label for="edit-duree">Durée (min)</label>
                <input type="number" id="edit-duree" class="form-control">
            </div>
            <div class="form-group">
                <label for="edit-projet">Projet</label>
                <input type="text" id="edit-projet" class="form-control">
            </div>

            <div class="modal-actions">
                <button onclick="saveTaskChanges()" class="btn">Enregistrer</button>
                <button onclick="closeEditModal()" class="btn btn-secondary">Annuler</button>
                <button onclick="deleteTask()" class="btn btn-danger" style="margin-left: auto;">Supprimer</button>
            </div>
        </div>
    </div>


    <script>
        // (Toutes les variables globales et fonctions précédentes sont ici...)
        const API_BASE_URL = window.location.origin;
        const LOCAL_STORAGE_KEY = 'ia_assistant_inventaire';
        let inventaireGlobal = [];
        const JOURS = ['Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam', 'Dim'];
        let dateActuelle = new Date();

        // (changeView, toggleDateFields, chargerInventaireLocal, sauvegarderInventaireLocal, apiPost...)
        // ...
        
        // ---------------------------------------------------------------------
        // LOGIQUE MÉTIER (TÂCHES) - MIS À JOUR
        // ---------------------------------------------------------------------

        async function fetchPriorites() {
            const listElement = document.getElementById('priority-list');
            listElement.innerHTML = '<div class="empty-state">Calcul...</div>';

            const priorites = await apiPost('/api/v1/taches/priorite', { inventaire: inventaireGlobal });

            if (priorites && priorites.length > 0) {
                listElement.innerHTML = ''; 
                priorites.forEach(tache => {
                    const item = document.createElement('div');
                    
                    let priorityClass = 'low';
                    if (tache.urgence >= 4 || tache.importance >= 4) priorityClass = 'medium';
                    if (tache.urgence === 5 && tache.importance === 5) priorityClass = 'high';
                    
                    item.className = `task-item ${priorityClass}`;
                    
                    // --- MODIFICATION : Ajout de openEditModal() ---
                    // L'item entier est cliquable pour l'édition
                    item.setAttribute('onclick', `openEditModal(${tache.db_id})`);
                    
                    item.innerHTML = `
                        <div class="task-info">
                            <strong>${tache.nom}</strong>
                            <small>${tache.projet} | Imp: ${tache.importance} | Urg: ${tache.urgence} | Durée: ${tache.duree_totale_minutes}min</small>
                        </div>
                        <button class="btn btn-terminer" onclick="event.stopPropagation(); terminerTache(${tache.db_id})">Terminer</button>
                    `;
                    listElement.appendChild(item);
                });
            } else if (priorites) {
                listElement.innerHTML = '<div class="empty-state">✅ Aucune tâche active.</div>';
            }
        }

        // (ajouterTache - Inchangée)
        // ...

        async function terminerTache(db_id) {
            // (La fonction terminerTache est inchangée, mais on ajoute une confirmation)
            if (!confirm("Voulez-vous vraiment marquer cet événement comme terminé ?")) return;

            const payload = { inventaire: inventaireGlobal, db_id: db_id };
            const nouvelInventaire = await apiPost('/api/v1/taches/terminer', payload);

            if (nouvelInventaire) {
                sauvegarderInventaireLocal(nouvelInventaire);
            }
        }

        // ---------------------------------------------------------------------
        // NOUVEAU : FONCTIONS DU MODAL D'ÉDITION
        // ---------------------------------------------------------------------

        function openEditModal(db_id) {
            const event = inventaireGlobal.find(e => e.db_id === db_id);
            if (!event) {
                alert("Erreur: Impossible de trouver l'événement.");
                return;
            }

            // Remplir le formulaire du modal
            document.getElementById('edit-db-id').value = event.db_id;
            document.getElementById('edit-nom').value = event.nom;
            document.getElementById('edit-importance').value = event.importance;
            document.getElementById('edit-urgence').value = event.urgence;
            document.getElementById('edit-duree').value = event.duree_totale_minutes;
            document.getElementById('edit-projet').value = event.projet;

            // Afficher le modal
            document.getElementById('edit-modal').style.display = 'flex';
        }

        function closeEditModal() {
            document.getElementById('edit-modal').style.display = 'none';
        }

        function saveTaskChanges() {
            const db_id = parseInt(document.getElementById('edit-db-id').value);
            
            // Trouver l'index de l'objet dans l'inventaire
            const eventIndex = inventaireGlobal.findIndex(e => e.db_id === db_id);
            if (eventIndex === -1) {
                alert("Erreur: Impossible de sauvegarder les modifications.");
                return;
            }

            // Mettre à jour l'objet directement dans l'inventaire global
            inventaireGlobal[eventIndex].nom = document.getElementById('edit-nom').value;
            inventaireGlobal[eventIndex].importance = parseInt(document.getElementById('edit-importance').value);
            inventaireGlobal[eventIndex].urgence = parseInt(document.getElementById('edit-urgence').value);
            inventaireGlobal[eventIndex].duree_totale_minutes = parseInt(document.getElementById('edit-duree').value);
            inventaireGlobal[eventIndex].projet = document.getElementById('edit-projet').value;

            // Sauvegarder l'inventaire modifié dans le localStorage
            // (Note: L'API n'est PAS appelée, tout est client-side)
            sauvegarderInventaireLocal(inventaireGlobal);
            
            // Fermer le modal
            closeEditModal();
        }
        
        function deleteTask() {
            if (!confirm("Êtes-vous sûr de vouloir supprimer cet événement définitivement ?")) return;
            
            const db_id = parseInt(document.getElementById('edit-db-id').value);
            
            // Filtrer l'inventaire pour supprimer l'objet
            const nouvelInventaire = inventaireGlobal.filter(e => e.db_id !== db_id);
            
            sauvegarderInventaireLocal(nouvelInventaire);
            closeEditModal();
        }


        // (Fonctions du Calendrier - Inchangées)
        // ...

        // (Fonctions de Sauvegarde/Chargement - Inchangées)
        // ...

        // (Démarrage de l'application - Inchangé)
        window.onload = () => {
            chargerInventaireLocal();
            toggleDateFields(); 
            const tasksNav = document.querySelector('.nav-item[data-view="tasks-view"]');
            changeView('tasks-view', tasksNav);
            fetchPriorites();
        };

    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Assistant IA - Priorisation</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 0; padding: 20px; background-color: #f4f4f9; color: #333; }
        .container { max-width: 600px; margin: 0 auto; background: #fff; padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); }
        h1 { color: #2c3e50; text-align: center; margin-bottom: 25px; }
        .task-form { display: flex; flex-direction: column; gap: 10px; padding-bottom: 20px; border-bottom: 1px solid #eee; }
        .task-form input, .task-form select { padding: 10px; border: 1px solid #ccc; border-radius: 6px; }
        .task-form button, .btn-action { background-color: #3498db; color: white; padding: 10px; border: none; border-radius: 6px; cursor: pointer; font-size: 16px; transition: background-color 0.3s; }
        .task-form button:hover, .btn-action:hover { background-color: #2980b9; }
        .priority-list { margin-top: 20px; }
        .task-item { background: #ecf0f1; padding: 15px; margin-bottom: 10px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; border-left: 5px solid #e74c3c; }
        .task-item.high { border-left-color: #e74c3c; }
        .task-item.medium { border-left-color: #f39c12; }
        .task-item.low { border-left-color: #2ecc71; }
        .task-info { flex-grow: 1; }
        .task-info strong { display: block; font-size: 1.1em; }
        .score { font-weight: bold; color: #e74c3c; margin-left: 10px; }
        .empty-state { text-align: center; color: #7f8c8d; padding: 20px; border: 1px dashed #bdc3c7; border-radius: 8px; margin-top: 20px; }
        /* Actions de sauvegarde */
        .sync-actions { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; margin-top: 20px; padding-top: 20px; border-top: 1px solid #eee; }
        .btn-green { background-color: #27ae60; }
        .btn-green:hover { background-color: #219d54; }
        .btn-orange { background-color: #f39c12; }
        .btn-orange:hover { background-color: #e67e22; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Assistant IA - T√¢ches Prioritaires</h1>

        <div class="task-form">
            <h2>Ajouter une Nouvelle T√¢che</h2>
            <input type="text" id="nom" placeholder="Nom de la t√¢che" required>
            <div style="display: flex; gap: 10px;">
                <select id="importance">
                    <option value="1">Importance: Faible (1)</option>
                    <option value="3" selected>Importance: Moyenne (3)</option>
                    <option value="5">Importance: Forte (5)</option>
                </select>
                <select id="urgence">
                    <option value="1">Urgence: Basse (1)</option>
                    <option value="3" selected>Urgence: Moyenne (3)</option>
                    <option value="5">Urgence: Haute (5)</option>
                </select>
                <input type="number" id="duree" placeholder="Dur√©e (min)" value="60" min="5">
            </div>
            <input type="text" id="projet" placeholder="Projet (ex: D√©veloppement)" value="Divers">
            <button onclick="ajouterTache()">Ajouter & Prioriser</button>
        </div>
        
        <h2>Liste de Priorit√©</h2>
        <div id="priority-list" class="priority-list">
            <div class="empty-state">Chargement...</div>
        </div>

        <div class="sync-actions">
            <button class="btn-action btn-green" onclick="telechargerInventaire()">üíæ T√©l√©charger l'Inventaire (JSON)</button>
            
            <label for="uploadFile" class="btn-action btn-orange" style="cursor: pointer;">
                ‚¨ÜÔ∏è Charger l'Inventaire (JSON)
            </label>
            <input type="file" id="uploadFile" style="display: none;" onchange="chargerFichierInventaire(event)">
        </div>
    </div>

    <script>
        // L'URL de votre API sur Render
        const API_BASE_URL = window.location.origin;
        const LOCAL_STORAGE_KEY = 'ia_assistant_inventaire';

        // Variable globale (la "m√©moire" du client)
        let inventaireGlobal = [];

        // ---------------------------------------------------------------------
        // 1. GESTION DU LOCAL STORAGE (Persistance C√¥t√© Mobile)
        // ---------------------------------------------------------------------

        function chargerInventaireLocal() {
            try {
                const data = localStorage.getItem(LOCAL_STORAGE_KEY);
                if (data) {
                    inventaireGlobal = JSON.parse(data);
                }
            } catch (error) {
                console.error("Erreur de chargement LocalStorage:", error);
                inventaireGlobal = [];
            }
        }

        function sauvegarderInventaireLocal(nouveauInventaire) {
            inventaireGlobal = nouveauInventaire;
            localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(inventaireGlobal));
            fetchPriorites(); // Rafra√Æchir l'affichage apr√®s la sauvegarde
        }

        // ---------------------------------------------------------------------
        // 2. COMMUNICATION API (Envoi des donn√©es √† traiter)
        // ---------------------------------------------------------------------

        async function apiPost(endpoint, dataToSend) {
            try {
                const response = await fetch(`${API_BASE_URL}${endpoint}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(dataToSend)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || `Erreur HTTP ${response.status}`);
                }
                
                return await response.json();
            } catch (error) {
                console.error("Erreur API:", error);
                alert(`Erreur de connexion ou de traitement : ${error.message}`);
                return null;
            }
        }

        // ---------------------------------------------------------------------
        // 3. LOGIQUE M√âTIER
        // ---------------------------------------------------------------------

        async function fetchPriorites() {
            const listElement = document.getElementById('priority-list');
            listElement.innerHTML = '<div class="empty-state">Calcul de priorit√©...</div>';

            const priorites = await apiPost('/api/v1/taches/priorite', { inventaire: inventaireGlobal });

            if (priorites && priorites.length > 0) {
                listElement.innerHTML = '';
                priorites.forEach(tache => {
                    const item = document.createElement('div');
                    
                    let priorityClass = 'low';
                    if (tache.score_priorite >= 8) {
                        priorityClass = 'high';
                    } else if (tache.score_priorite >= 4) {
                        priorityClass = 'medium';
                    }
                    
                    item.className = `task-item ${priorityClass}`;
                    item.innerHTML = `
                        <div class="task-info">
                            <strong>${tache.nom}</strong>
                            <small>${tache.projet} | Imp: ${tache.importance} | Urg: ${tache.urgence} | Dur√©e: ${tache.duree_totale_minutes}min</small>
                        </div>
                        <span class="score">${tache.score_priorite}</span>
                        <button class="btn-action" style="margin-left: 10px; background-color: #e74c3c;" onclick="terminerTache(${tache.db_id})">Terminer</button>
                    `;
                    listElement.appendChild(item);
                });
            } else if (priorites) {
                listElement.innerHTML = '<div class="empty-state">‚úÖ Aucune t√¢che active n\'est √† prioriser.</div>';
            }
        }

        async function ajouterTache() {
            const nom = document.getElementById('nom').value;
            const importance = document.getElementById('importance').value;
            const urgence = document.getElementById('urgence').value;
            const duree = document.getElementById('duree').value;
            const projet = document.getElementById('projet').value;

            if (!nom || !duree) {
                alert("Veuillez remplir le nom et la dur√©e de la t√¢che.");
                return;
            }
            
            const payload = {
                inventaire: inventaireGlobal, 
                nom: nom,
                importance: importance,
                urgence: urgence,
                duree: duree,
                projet: projet
            };

            const nouvelInventaire = await apiPost('/api/v1/taches/ajouter', payload);
            
            if (nouvelInventaire) {
                sauvegarderInventaireLocal(nouvelInventaire);
                document.getElementById('nom').value = '';
                document.getElementById('projet').value = 'Divers';
            }
        }

        async function terminerTache(db_id) {
            if (!confirm("Voulez-vous vraiment marquer cette t√¢che comme termin√©e ?")) return;

            const payload = {
                inventaire: inventaireGlobal,
                db_id: db_id
            };

            const nouvelInventaire = await apiPost('/api/v1/taches/terminer', payload);

            if (nouvelInventaire) {
                sauvegarderInventaireLocal(nouvelInventaire);
            }
        }

        // ---------------------------------------------------------------------
        // 4. FONCTION DE T√âL√âCHARGEMENT (Sauvegarde Manuelle / Cloud)
        // ---------------------------------------------------------------------
        
        function telechargerInventaire() {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(inventaireGlobal, null, 2));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", `assistant_inventaire_${new Date().toISOString().slice(0, 10)}.json`);
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
            alert("Inventaire JSON t√©l√©charg√© ! Transf√©rez-le sur votre stockage Cloud (GitHub, Drive...) pour le conserver.");
        }

        // ---------------------------------------------------------------------
        // 5. FONCTION DE CHARGEMENT DE FICHIER (Restauration Manuelle / Cloud)
        // ---------------------------------------------------------------------

        function chargerFichierInventaire(event) {
            const file = event.target.files[0];
            if (!file) return;

            if (file.type !== "application/json") {
                alert("Veuillez s√©lectionner un fichier JSON valide.");
                return;
            }

            const reader = new FileReader();
            
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    if (!Array.isArray(data)) {
                         throw new Error("Le fichier JSON n'est pas une liste valide.");
                    }
                    
                    sauvegarderInventaireLocal(data);
                    alert("Inventaire charg√© avec succ√®s ! L'application est mise √† jour.");
                    
                } catch (error) {
                    console.error("Erreur de lecture ou de format JSON:", error);
                    alert(`Erreur: Impossible de lire le fichier. Le format est-il correct ? (${error.message})`);
                }
            };

            reader.readAsText(file);
            document.getElementById('uploadFile').value = ''; 
        }

        // ---------------------------------------------------------------------
        // D√âMARRAGE DE L'APPLICATION
        // ---------------------------------------------------------------------

        window.onload = () => {
            chargerInventaireLocal();
            fetchPriorites();
        };

    </script>
</body>
</html>